# План рефакторинга: Domain-Centric Order Flow

Этот документ описывает технические шаги по выносу бизнес-логики оформления заказа из контроллеров (Views) в отдельный слой сервисов.

## Цель
Переход от структуры, где фреймворк (Django/DRF) диктует логику, к структуре, где логика независима и может быть вызвана из любого места (API, Telegram-бот, скрипты).

## Что будет сделано

### 1. Слой DTO (Data Transfer Objects)
- **Файл:** `shop/dto.py`
- **Что:** Создание простых структур данных (dataclasses), которые описывают входные параметры для заказа.
- **Зачем:** Чтобы логика не зависела от объекта `request`.

### 2. Слой Services (Бизнес-логика)
- **Файл:** `shop/services.py`
- **Что:** Функция `create_order`, которая инкапсулирует:
    - Проверку корзины.
    - Атомарную проверку и блокировку остатков товаров (`select_for_update`).
    - Создание записей в БД.
    - Очистку корзины.
- **Зачем:** Это "сердце" приложения. Теперь его можно тестировать отдельно от веба.

### 3. Рефакторинг View (Тонкий контроллер)
- **Файл:** `shop/views/orders.py`
- **Что:** Метод `checkout` теперь будет только:
    - Валидировать входящий JSON.
    - Передавать данные в сервис.
    - Возвращать ответ или ошибку.
- **Зачем:** Следование принципу Single Responsibility (Единственной ответственности).

## Как проверять
1. **Тесты:** Существующие тесты `tests_robustness.py` должны проходить без изменений.
2. **Swagger:** Проверка через UI должна подтвердить, что формат входных и выходных данных остался прежним.

---
> [!NOTE]
> Этот рефакторинг является ключевым этапом для перехода к уровню Senior Developer.
